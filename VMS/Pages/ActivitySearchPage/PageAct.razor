@using Geolocation;
@using VMS.Application.Interfaces
@using VMS.Application.ViewModels
@inject IJSRuntime JsRuntime
@using Coordinate = VMS.Application.ViewModels.Coordinate;
@using VMS.Domain.Models

<section class="my-act">
    <div class="container">
        <div class="row">
            <div class="act col-8 ps-0" id="act">
                <h3>Có <span>@(activities is null ? "0" : activities.Count) hoạt động</span> đang cần tình nguyện viên ứng với kết quả tìm kiếm</h3>
                <div class="px-2">
                    <div class="act__page-1">
                        @if (pagedResult is not null && pagedResult.Results.Count != 0)
                        {
                            @foreach (var item in pagedResult.Results)
                            {
                                <div class="act__item row mt-5">
                                    <div class="col-4">
                                        <img class="w-100" src="img/@item.Banner" alt="">
                                    </div>
                                    <div class="col-8 act__content">
                                        <a href="@Routes.ActivityInfo/@item.Id" class="lmtext-3">@item.Name</a>
                                        <h5>
                                            <i class="material-icons">public</i>@item.Organizer
                                        </h5>
                                        <p class="lmtext-2">@item.Description</p>
                                        <span>Ngày đăng: @item.PostDate.ToString("dd/MM/yyyy")</span>
                                        <AuthorizeView>
                                            <Authorized>
                                                <div class="act__signUp">
                                                    <i @onclick="() => HandleFavorite(item.Id)" class="material-icons">@(userFavorites.Exists(f => f.ActivityId == item.Id) ? "favorite" : "favorite_border")</i>

                                                    <button @onclick="() => ShowModal(item.Id)" class="btn">Đăng kí</button>
                                                </div>
                                            </Authorized>
                                        </AuthorizeView>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
                <a class="goToDivAct d-none " href="#act">go to div act</a>
            </div>
            <div class="col-3 ms-auto">
                <FeaturedAct FeaturedActivities=@featuredActivities></FeaturedAct>
            </div>
        </div>
    </div>
</section>

<Pager CurrentPage="@pagedResult.CurrentPage"
       PageCount="@pagedResult.PageCount"
       OnPageChanged="@(async (e)=> { page = e; await HandlePageChanged(); })" />

@code {
    private List<Favorite> userFavorites;
    private int page = 1;
    private Coordinate location;
    private List<ActivityViewModel> activities;
    private IEnumerable<ActivityViewModel> featuredActivities;
    private PagedResult<ActivityViewModel> pagedResult = new() { Results = new() };

    [Parameter]
    public bool IsSearch { get; set; }
    [Parameter]
    public FilterActivityViewModel Filter { get; set; }
    [Parameter]
    public string SearchValue { get; set; }
    [Parameter]
    public bool[] OrderList { get; set; }

    [CascadingParameter]
    public IModalService Modal { get; set; }

    [Inject]
    private IActivityService ActivityService { get; set; }
    [Inject]
    private IIdentityService IdentityService { get; set; }
    [Inject]
    private IGeoLocationService AddressLocationService { get; set; }

    public abstract class PagedResultBase
    {
        public int CurrentPage { get; set; }
        public int PageCount { get; set; }
        public int PageSize { get; set; }
        public int RowCount { get; set; }
        public int FirstRowOnPage => Math.Min((CurrentPage - 1) * PageSize + 1, RowCount);
        public int LastRowOnPage => Math.Min(CurrentPage * PageSize, RowCount);
    }

    public class PagedResult<T> : PagedResultBase where T : class
    {
        public List<T> Results { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JsRuntime.InvokeVoidAsync("vms.SetUserLocation");
    }

    protected override async Task OnInitializedAsync()
    {
        featuredActivities = await ActivityService.GetFeaturedActivitiesAsync();

        location = await JsRuntime.InvokeAsync<Coordinate>("vms.GetUserLocation");
        if (location is null)
        {
            string userAddresses = IdentityService.GetCurrentUserAddress();
            location = await AddressLocationService.GetCoordinateAsync(userAddresses);
        }

        userFavorites = IdentityService.GetFavoritesOfCurrentUser();
    }

    protected override async Task OnParametersSetAsync()
    {
        activities = await ActivityService.GetAllActivitiesAsync(IsSearch, SearchValue, Filter);
        HandleOrder();
        pagedResult = GetData();
    }

    private async Task HandlePageChanged()
    {
        pagedResult = GetData();
        StateHasChanged();
        await Interop.ScrollToTop(JsRuntime);
    }

    private void HandleFavorite(int id)
    {
        userFavorites = IdentityService.UpdateFavoritesOfCurrentUser(id);
    }

    private void HandleOrder()
    {
        if (OrderList[0] && OrderList[1] && OrderList[2])
        {
            activities = activities.OrderByDescending(a => a.PostDate)
                                        .ThenByDescending(a => a.MemberQuantity)
                                        .ThenBy(a => GeoCalculator.GetDistance(location.Latitude, location.Longitude, a.Coordinate.Latitude, a.Coordinate.Longitude, 2, DistanceUnit.Meters))
                                        .ToList();
            return;
        }

        if (OrderList[0] && OrderList[2])
        {
            activities = activities.OrderByDescending(a => a.PostDate)
                                        .ThenByDescending(a => a.MemberQuantity)
                                        .ToList();
            return;
        }

        if (OrderList[0] && OrderList[1])
        {
            activities = activities.OrderByDescending(a => a.PostDate)
                                        .ThenBy(a => GeoCalculator.GetDistance(location.Latitude, location.Longitude, a.Coordinate.Latitude, a.Coordinate.Longitude, 2, DistanceUnit.Meters))
                                        .ToList();
            return;
        }

        if (OrderList[1] && OrderList[2])
        {
            activities = activities.OrderByDescending(a => a.MemberQuantity)
                                        .ThenBy(a => GeoCalculator.GetDistance(location.Latitude, location.Longitude, a.Coordinate.Latitude, a.Coordinate.Longitude, 2, DistanceUnit.Meters))
                                        .ToList();
            return;
        }

        if (OrderList[0])
        {
            activities = activities.OrderByDescending(a => a.PostDate).ToList();
        }

        if (OrderList[2])
        {
            activities = activities.OrderByDescending(a => a.MemberQuantity).ToList();
        }

        if (OrderList[1])
        {
            activities = activities.OrderBy(a => GeoCalculator.GetDistance(location.Latitude, location.Longitude, a.Coordinate.Latitude, a.Coordinate.Longitude, 2, DistanceUnit.Meters)).ToList();
        }
    }

    private PagedResult<ActivityViewModel> GetData()
    {
        var result = new PagedResult<ActivityViewModel>();
        result.CurrentPage = page;
        result.RowCount = activities.Count;
        result.PageSize = 20;
        result.PageCount = result.RowCount / result.PageSize;
        result.Results = activities.Skip((page - 1) * result.PageSize).Take(result.PageSize).ToList();

        return result;
    }

    private void ShowModal(int id)
    {
        ModalParameters parameters = new();
        parameters.Add("ActivityId", id);

        var options = new ModalOptions()
        {
            HideCloseButton = true,
            DisableBackgroundCancel = true,
            UseCustomLayout = true,
        };

        Modal.Show<Signup>("", parameters, options);
    }

}